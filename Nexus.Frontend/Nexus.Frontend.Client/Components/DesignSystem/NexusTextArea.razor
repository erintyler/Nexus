@* Modern textarea component following Nexus design system *@

<div class="@WrapperClasses">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <NexusLabel For="@Id" IsRequired="@IsRequired">@Label</NexusLabel>
    }
    
    <textarea 
        id="@Id"
        rows="@Rows"
        maxlength="@MaxLength"
        class="@GetTextAreaClasses()"
        placeholder="@Placeholder"
        disabled="@Disabled"
        @oninput="HandleInput"
        @attributes="AdditionalAttributes">@Value</textarea>
    
    <div class="flex items-center justify-between mt-2">
        <div class="flex-1">
            @if (!string.IsNullOrWhiteSpace(HelperText))
            {
                <p class="text-xs text-gray-500">@HelperText</p>
            }
            
            @if (!string.IsNullOrWhiteSpace(ErrorMessage))
            {
                <p class="text-red-600 text-sm font-medium">@ErrorMessage</p>
            }
        </div>
        
        @if (ShowCharacterCount && MaxLength.HasValue)
        {
            <p class="@GetCharacterCountClasses()">
                @GetCurrentLength() / @MaxLength
            </p>
        }
    </div>
</div>

@code {
    /// <summary>
    /// Textarea value
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Value changed callback
    /// </summary>
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    /// <summary>
    /// Textarea label
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Textarea placeholder
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    /// <summary>
    /// Number of rows
    /// </summary>
    [Parameter]
    public int Rows { get; set; } = 4;

    /// <summary>
    /// Whether the textarea is required
    /// </summary>
    [Parameter]
    public bool IsRequired { get; set; }

    /// <summary>
    /// Whether the textarea is disabled
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Helper text to display below the textarea
    /// </summary>
    [Parameter]
    public string? HelperText { get; set; }

    /// <summary>
    /// Error message to display
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// Additional CSS classes for the wrapper
    /// </summary>
    [Parameter]
    public string? WrapperClasses { get; set; }

    /// <summary>
    /// Textarea ID
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"textarea-{Guid.NewGuid():N}";

    /// <summary>
    /// Maximum character length
    /// </summary>
    [Parameter]
    public int? MaxLength { get; set; }

    /// <summary>
    /// Whether to show the character count
    /// </summary>
    [Parameter]
    public bool ShowCharacterCount { get; set; } = true;

    /// <summary>
    /// Additional HTML attributes
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private string GetTextAreaClasses()
    {
        var baseClasses = "w-full px-4 py-3 bg-white/80 backdrop-blur-sm rounded-xl shadow-sm outline-none transition-all duration-200 hover:shadow-md resize-none";
        
        var borderClasses = !string.IsNullOrWhiteSpace(ErrorMessage)
            ? "border-2 border-red-400 focus:ring-2 focus:ring-red-500"
            : "border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500";
        
        return $"{baseClasses} {borderClasses}".Trim();
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        
        // Enforce max length if specified
        if (MaxLength.HasValue && value.Length > MaxLength.Value)
        {
            value = value[..MaxLength.Value];
        }
        
        Value = value;
        await ValueChanged.InvokeAsync(value);
    }

    private int GetCurrentLength()
    {
        return Value?.Length ?? 0;
    }

    private string GetCharacterCountClasses()
    {
        var baseClasses = "text-xs font-medium ml-2 whitespace-nowrap";
        
        if (!MaxLength.HasValue)
        {
            return $"{baseClasses} text-gray-500";
        }

        var currentLength = GetCurrentLength();
        var percentage = (double)currentLength / MaxLength.Value;

        var colorClasses = percentage switch
        {
            >= 1.0 => "text-red-600",
            >= 0.9 => "text-amber-600",
            _ => "text-gray-500"
        };

        return $"{baseClasses} {colorClasses}";
    }
}
