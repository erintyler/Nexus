name: Pull Request CI

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Formatting Checks
    runs-on: ubuntu-slim
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/packages.lock.json'
      
      - name: Run dotnet format check
        run: dotnet format Nexus.slnx --verify-no-changes --verbosity normal

  # Job 2: Build & Compile
  build:
    name: Build Solution
    runs-on: ubuntu-slim
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/packages.lock.json'
      
      - name: Restore dependencies
        run: dotnet restore Nexus.slnx
      
      - name: Build solution
        run: dotnet build Nexus.slnx --no-restore --configuration Release
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/**
            **/obj/Release/**
          retention-days: 1

  # Job 3: Architecture Tests
  architecture-tests:
    name: Architecture Tests
    runs-on: ubuntu-slim
    needs: build
    continue-on-error: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Run Architecture Tests
        run: |
          dotnet test Nexus.slnx \
            --project Nexus.Architecture.Tests \
            --no-restore \
            --no-build \
            --configuration Release

  # Job 4: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-slim
    needs: build
    continue-on-error: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Run Domain Unit Tests
        run: |
          dotnet test \
            --project Nexus.Domain.UnitTests \
            --no-restore \
            --no-build \
            --configuration Release
      
      - name: Run Application Unit Tests
        run: |
          dotnet test \
            --project Nexus.Application.UnitTests \
            --no-restore \
            --no-build \
            --configuration Release
      
      - name: Run Frontend Unit Tests
        run: |
          dotnet test \
            --project Nexus.Frontend.UnitTests \
            --no-restore \
            --no-build \
            --configuration Release

  # Job 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-slim
    needs: build
    continue-on-error: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Run API Integration Tests
        run: |
          dotnet test \
            --project Nexus.Api.IntegrationTests \
            --no-restore \
            --no-build \
            --configuration Release
      
      - name: Run Migration Tests
        run: |
          dotnet test \
            --project Nexus.Migrations.IntegrationTests \
            --no-restore \
            --no-build \
            --configuration Release

  # Job 6: CodeQL Security Analysis
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-slim
    needs: build
    continue-on-error: false
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/packages.lock.json'
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"
          upload: true

  # Job 7: PR Summary & Status Check
  pr-check-summary:
    name: PR Check Summary
    runs-on: ubuntu-slim
    needs: [code-quality, build, architecture-tests, unit-tests, integration-tests, codeql]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "## PR Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture Tests | ${{ needs.architecture-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Security | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Verify all checks passed
        if: |
          needs.code-quality.result != 'success' ||
          needs.build.result != 'success' ||
          needs.architecture-tests.result != 'success' ||
          needs.unit-tests.result != 'success' ||
          needs.integration-tests.result != 'success' ||
          needs.codeql.result != 'success'
        run: |
          echo "❌ One or more required checks failed"
          exit 1
      
      - name: Success
        run: echo "✅ All PR checks passed successfully!"

